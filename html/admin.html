<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - OLD VERSION</title>
    <link rel="stylesheet" href="../css/admin.css?v=REALLY_OLD">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF library from unpkg - most reliable -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <!-- ADMIN ACCESS PROTECTION -->
    <script>
        // Check if user is admin BEFORE loading the page
        (function checkAdminAccess() {
            const currentUser = JSON.parse(
                localStorage.getItem('voicebox_current_user') ||
                sessionStorage.getItem('voicebox_current_user') ||
                '{}'
            );

            // If NOT admin, redirect immediately
            if (currentUser.role !== 'admin') {
                console.warn('‚õî Unauthorized access attempt to admin panel!');
                console.warn('Redirecting to login...');

                // Clear any fake sessions
                localStorage.removeItem('voicebox_current_user');
                sessionStorage.removeItem('voicebox_current_user');

                // Show alert
                alert('‚õî ACCESS DENIED!\n\nThis is a restricted area.\nOnly authorized administrators can access this page.\n\nRedirecting to login...');

                // Redirect to admin login
                window.location.href = 'admin-login-simple.html';

                // Stop page from loading
                throw new Error('Unauthorized access');
            }

            console.log('‚úÖ Admin access granted:', currentUser.email);
        })();
    </script>

    <script>
        // Test if jsPDF loaded
        window.addEventListener('DOMContentLoaded', function () {
            const checkPDF = setInterval(() => {
                if (window.jspdf && window.jspdf.jsPDF) {
                    console.log('‚úì jsPDF loaded successfully');
                    clearInterval(checkPDF);
                } else {
                    console.log('Waiting for jsPDF...');
                }
            }, 100);
            setTimeout(() => clearInterval(checkPDF), 3000);
        });
    </script>
</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <rect width="40" height="40" rx="12" fill="url(#gradient1)" />
                    <path d="M20 10 L30 20 L20 30 L10 20 Z" fill="white" opacity="0.9" />
                    <defs>
                        <linearGradient id="gradient1" x1="0" y1="0" x2="40" y2="40">
                            <stop offset="0%" stop-color="#6366f1" />
                            <stop offset="100%" stop-color="#8b5cf6" />
                        </linearGradient>
                    </defs>
                </svg>
                <span>Admin Panel</span>
            </div>

            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                    Dashboard
                </a>
                <a href="#" class="nav-item" data-page="users">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                    Users
                </a>
                <a href="#" class="nav-item" data-page="scans">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                        <circle cx="12" cy="13" r="4" />
                    </svg>
                    Bill Scans
                </a>
                <a href="#" class="nav-item" data-page="payments">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke="width="
                        2">
                        <rect x="2" y="5" width="20" height="14" rx="2" />
                        <path d="M2 10h20" />
                    </svg>
                    Payments
                </a>
                <a href="#" class="nav-item" data-page="analytics">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="20" x2="12" y2="10" />
                        <line x1="18" y1="20" x2="18" y2="4" />
                        <line x1="6" y1="20" x2="6" y2="16" />
                    </svg>
                    Analytics
                </a>
            </nav>

            <div class="user-profile">
                <img src="https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff" alt="Admin"
                    id="adminAvatar">
                <div class="user-info">
                    <h4 id="adminName">Admin User</h4>
                    <p id="adminEmail"
                        style="font-size: 11px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;">
                        admin@voicebox.com</p>
                </div>

                <!-- Edit Button -->
                <button class="logout-btn" onclick="openProfileModal()" style="margin-right: 5px; color: #6366f1;"
                    title="Edit Profile">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>

                <button class="logout-btn" id="logoutBtn" title="Logout">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Profile Edit Modal -->
        <div id="profileModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
            <div
                style="background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <h3 style="margin-bottom: 20px; color: #333;">‚úèÔ∏è Edit Admin Profile</h3>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">Display
                        Name</label>
                    <input type="text" id="editName"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">Email
                        Address</label>
                    <input type="email" id="editEmail"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="document.getElementById('profileModal').style.display='none'"
                        style="padding: 10px 20px; background: #f3f4f6; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button onclick="saveProfile()"
                        style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">Save
                        Changes</button>
                </div>
            </div>
        </div>

        <script>
            // Load current details
            function openProfileModal() {
                document.getElementById('profileModal').style.display = 'flex';
                document.getElementById('editName').value = document.getElementById('adminName').textContent;
                document.getElementById('editEmail').value = document.getElementById('adminEmail').textContent;
            }

            // Save new details
            function saveProfile() {
                const newName = document.getElementById('editName').value;
                const newEmail = document.getElementById('editEmail').value;

                if (newName && newEmail) {
                    // Update UI
                    document.getElementById('adminName').textContent = newName;
                    document.getElementById('adminEmail').textContent = newEmail;

                    // Update Avatar
                    document.getElementById('adminAvatar').src = `https://ui-avatars.com/api/?name=${newName}&background=6366f1&color=fff`;

                    // Save to local storage (Mock update)
                    const user = JSON.parse(localStorage.getItem('voicebox_current_user') || '{}');
                    user.name = newName;
                    user.email = newEmail;
                    localStorage.setItem('voicebox_current_user', JSON.stringify(user));

                    document.getElementById('profileModal').style.display = 'none';
                    alert('‚úÖ Profile Updated Successfully!');
                }
            }
        </script>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <h1 id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <button class="refresh-btn" id="refreshBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="23 4 23 10 17 10" />
                            <polyline points="1 20 1 14 7 14" />
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                        </svg>
                    </button>
                    <!-- demo toggle removed; admin shows real data only -->
                    <div class="search-box">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="11" cy="11" r="8" />
                            <path d="M21 21l-4.35-4.35" />
                        </svg>
                        <input type="text" placeholder="Search..." id="searchInput">
                    </div>
                </div>
            </header>

            <!-- Dashboard Page -->
            <div class="page active" id="dashboard">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <p class="stat-label">Total Users</p>
                            <h2 class="stat-value" id="dashTotalUsers">0</h2>
                            <span class="stat-change positive">+12% from last month</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon success">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                                <circle cx="12" cy="13" r="4" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <p class="stat-label">Bills Scanned</p>
                            <h2 class="stat-value" id="dashTotalScans">0</h2>
                            <span class="stat-change positive">+23% from last week</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="2" y="5" width="20" height="14" rx="2" />
                                <path d="M2 10h20" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <p class="stat-label">Total Transactions</p>
                            <h2 class="stat-value" id="dashTotalPayments">0</h2>
                            <span class="stat-change positive">+8% from yesterday</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23" />
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <p class="stat-label">Total Revenue</p>
                            <h2 class="stat-value">‚Çπ<span id="dashTotalRevenue">0</span></h2>
                            <span class="stat-change positive">+15% from last month</span>
                        </div>
                    </div>
                </div>

                <!-- Charts and Tables -->
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>Recent Activities</h3>
                        </div>
                        <div class="card-body">
                            <div class="activities-list" id="recentActivities">
                                <!-- Activities will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>Active Users (Live)</h3>
                        </div>
                        <div class="card-body">
                            <div class="users-list" id="activeUsers">
                                <!-- Active users will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Page -->
            <div class="page" id="users">
                <div class="card">
                    <div class="card-header">
                        <h3>All Users</h3>
                        <button class="btn-primary" id="exportUsersBtn"
                            style="display:flex; gap:0.5rem; align-items:center; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                            üì• Export
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Scans</th>
                                    <th>Payments</th>
                                    <th>Joined</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Scans Page -->
            <div class="page" id="scans">
                <div class="card">
                    <div class="card-header">
                        <h3>All Bill Scans</h3>
                        <button class="btn-primary" id="exportScansBtn"
                            style="display:flex; gap:0.5rem; align-items:center; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            üì• Export
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Language</th>
                                    <th>Scan Date</th>
                                    <th>Text Preview</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="scansTableBody">
                                <!-- Scans will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payments Page -->
            <div class="page" id="payments">
                <div class="card">
                    <div class="card-header">
                        <h3>All Transactions</h3>
                        <button class="btn-primary" id="exportPaymentsBtn"
                            style="display:flex; gap:0.5rem; align-items:center; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            üì• Export
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>User</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <!-- Payments will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div class="page" id="analytics">
                <div class="card">
                    <div class="card-header">
                        <h3>Analytics Overview</h3>
                    </div>
                    <div class="card-body">
                        <div class="analytics-grid">
                            <div class="analytics-item">
                                <h4>Most Active Users</h4>
                                <div id="topUsersChart"></div>
                            </div>
                            <div class="analytics-item">
                                <h4>Scans by Language</h4>
                                <div id="languageChart"></div>
                            </div>
                            <div class="analytics-item">
                                <h4>Daily Activity</h4>
                                <div id="activityChart"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Loading data...</p>
    </div>

    <!-- Export Choice Modal -->
    <div id="exportChoiceModal" class="modal hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:9999;">
        <div
            style="background:#1a1a2e; padding:2.5rem; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,0.5); max-width:420px; width:90%; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="margin-bottom:0.5rem; color:#ffffff; font-size:1.5rem; font-weight: 700;">üì• Choose Export Format
            </h3>
            <p style="color:#a0a0b8; margin-bottom:2rem; font-size:0.95rem;">Select the format you want to download the
                users data</p>
            <div style="display:flex; gap:1rem; justify-content:center; margin-bottom: 1.5rem;">
                <button id="exportCSVChoiceBtn"
                    style="padding:1rem 1.8rem; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; flex:1; font-size: 1rem; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);"
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'">
                    üìÑ CSV File
                </button>
                <button id="exportPDFChoiceBtn"
                    style="padding:1rem 1.8rem; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; flex:1; font-size: 1rem; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);"
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'">
                    üìï PDF Report
                </button>
            </div>
            <button id="exportCancelBtn"
                style="width:100%; padding:0.75rem; background:rgba(255,255,255,0.1); color:#a0a0b8; border:1px solid rgba(255,255,255,0.2); border-radius:10px; cursor:pointer; font-weight:500; font-size: 0.95rem; transition: all 0.2s;"
                onmouseover="this.style.background='rgba(255,255,255,0.15)'; this.style.color='#ffffff'"
                onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.color='#a0a0b8'">
                Cancel
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <script src="../js/admin.js?v=2.0"></script>
    <script src="../js/admin-individual-downloads.js?v=2.0"></script>

    <!-- INLINE SEARCH - FORCED TO WORK -->
    <script>
        // Force execution after everything loads
        setTimeout(function () {
            console.log('üîç ADMIN SEARCH - Initializing...');

            const searchInput = document.getElementById('searchInput');

            if (!searchInput) {
                console.error('‚ùå Search input NOT found!');
                alert('Search input missing! Check admin.html line 163');
                return;
            }

            console.log('‚úÖ Search input found:', searchInput);

            // Visual indicator that search is active



            searchInput.addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                const activePage = document.querySelector('.page.active');

                if (!activePage) {
                    console.warn('‚ö†Ô∏è No active page');
                    return;
                }

                const activeTable = activePage.querySelector('table tbody');
                if (!activeTable) {
                    console.warn('‚ö†Ô∏è No table in active page:', activePage.id);
                    return;
                }

                const rows = activeTable.querySelectorAll('tr');
                let visibleCount = 0;

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();

                    if (!searchTerm || text.includes(searchTerm)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                console.log(`üîç Search: "${searchTerm}" ‚Üí ${visibleCount} results`);

                // Visual feedback
                if (searchTerm) {

                } else {

                }
            });

            console.log('‚úÖ SEARCH ACTIVE - Type to test!');

        }, 2000); // Wait 2 seconds for everything to load
    </script>

    <!-- ULTRA SIMPLE WORKING SEARCH -->
    <script>(function () { 'use strict'; var c = 0; function t() { c++; var i = document.getElementById('searchInput'); if (i) { console.log('SEARCH ON'); i.onkeyup = function () { var s = this.value.toLowerCase(), f = 0, r = document.querySelectorAll('table tbody tr'); for (var j = 0; j < r.length; j++) { var x = r[j].textContent.toLowerCase(); if (s === '' || x.indexOf(s) >= 0) { r[j].style.display = ''; f++; } else { r[j].style.display = 'none'; } } console.log('Found:' + f); }; console.log('READY'); return true; } if (c < 30) { setTimeout(t, 200); } } t(); })();</script>
</body>

</html>