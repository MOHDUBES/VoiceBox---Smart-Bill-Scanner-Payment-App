<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - VoiceBox</title>
    <link rel="stylesheet" href="../css/auth.css">
</head>

<body>
    <div class="auth-container">
        <div class="auth-left">
            <div class="auth-content">
                <div class="logo-section">
                    <div class="logo-icon">üîê</div>
                    <h1 class="logo-text">Reset Password</h1>
                    <p class="tagline">Set a new password for your VoiceBox account</p>
                </div>

                <!-- Reset Password Form -->
                <form id="resetPasswordForm" class="auth-form">
                    <div class="form-group">
                        <label>New Password</label>
                        <div class="input-with-icon">
                            <input type="password" id="newPassword" placeholder="Enter new password" required
                                minlength="6">
                            <button type="button" class="toggle-password" onclick="togglePassword('newPassword')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                    <circle cx="12" cy="12" r="3" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Confirm Password</label>
                        <div class="input-with-icon">
                            <input type="password" id="confirmPassword" placeholder="Confirm new password" required
                                minlength="6">
                            <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                    <circle cx="12" cy="12" r="3" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="password-strength" id="passwordStrength"></div>

                    <button type="submit" class="btn-primary btn-full">Reset Password</button>

                    <div class="form-footer">
                        <a href="login.html" class="link">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Side - Same as login page -->
        <div class="auth-right">
            <div class="feature-card">
                <div class="feature-icon">üîê</div>
                <h3>Secure Reset</h3>
                <p>Your password reset link is encrypted and expires in 30 minutes for security.</p>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p>Resetting password...</p>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <p id="toastMessage"></p>
    </div>

    <script>
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const resetToken = urlParams.get('token');

        if (!resetToken) {
            alert('‚ùå Invalid reset link. Please request a new password reset.');
            window.location.href = 'login.html';
        }

        // Handle form submission
        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showToast('‚ùå Passwords do not match!', 'error');
                return;
            }

            // Validate password strength
            if (newPassword.length < 6) {
                showToast('‚ùå Password must be at least 6 characters', 'error');
                return;
            }

            showLoading(true);
            await resetPassword(newPassword);
        });

        // Reset Password Function
        async function resetPassword(newPassword) {
            const resets = JSON.parse(localStorage.getItem('voicebox_password_resets') || '[]');
            const resetData = resets.find(r => r.token === resetToken && !r.used);

            if (!resetData) {
                showLoading(false);
                showToast('‚ùå Invalid or expired reset link', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            // Check expiry
            if (Date.now() > resetData.expiry) {
                showLoading(false);
                showToast('‚ùå Reset link has expired. Please request a new one.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            // Update password
            const users = JSON.parse(localStorage.getItem('voicebox_users') || '[]');
            const userIndex = users.findIndex(u => u.email === resetData.email);

            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                localStorage.setItem('voicebox_users', JSON.stringify(users));

                // Mark token as used
                resetData.used = true;
                localStorage.setItem('voicebox_password_resets', JSON.stringify(resets));

                showLoading(false);
                showToast('‚úÖ Password reset successful! Redirecting to login...', 'success');

                console.log(`
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
PASSWORD RESET SUCCESSFUL
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Email: ${resetData.email}
New password set successfully!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                `);

                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            } else {
                showLoading(false);
                showToast('‚ùå User not found', 'error');
            }
        }

        // Toggle Password Visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Password Strength
        document.getElementById('newPassword').addEventListener('input', (e) => {
            const password = e.target.value;
            const strengthIndicator = document.getElementById('passwordStrength');

            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/)) strength++;
            if (password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;

            strengthIndicator.className = 'password-strength';

            if (strength <= 2) {
                strengthIndicator.classList.add('weak');
                strengthIndicator.textContent = '‚ö†Ô∏è Weak password';
            } else if (strength <= 4) {
                strengthIndicator.classList.add('medium');
                strengthIndicator.textContent = '‚úì Medium password';
            } else {
                strengthIndicator.classList.add('strong');
                strengthIndicator.textContent = '‚úì Strong password';
            }
        });

        // UI Helpers
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toast.className = 'toast';
            if (type === 'error') {
                toast.classList.add('error');
            }

            toastMessage.textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 4000);
        }
    </script>
</body>

</html>